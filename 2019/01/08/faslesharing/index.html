<!-- build time:Sun Jan 13 2019 23:05:57 GMT+0800 (China Standard Time) --><!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0"><link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"6.5.0",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="前言可谓是一入并发深似海，看得越多，发现自己懂的越少，总感觉自己只是了解了其冰山一角。但是在研究的过程中越来越感受到一些框架的设计之美，很细腻的赶脚。同时也让我get到了新的知识点。"><meta name="keywords" content="java jvm"><meta property="og:type" content="article"><meta property="og:title" content="并发不得不说的伪共享"><meta property="og:url" content="https://www.hcyhj.cn/2019/01/08/faslesharing/index.html"><meta property="og:site_name" content="mars Blog"><meta property="og:description" content="前言可谓是一入并发深似海，看得越多，发现自己懂的越少，总感觉自己只是了解了其冰山一角。但是在研究的过程中越来越感受到一些框架的设计之美，很细腻的赶脚。同时也让我get到了新的知识点。"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://upload-images.jianshu.io/upload_images/15055480-87e98ecb261662b9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><meta property="og:image" content="https://upload-images.jianshu.io/upload_images/15055480-e477d3af94aae0f3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><meta property="og:image" content="https://upload-images.jianshu.io/upload_images/15055480-b64e0bf573f58e89.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><meta property="og:updated_time" content="2019-01-08T15:50:35.429Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="并发不得不说的伪共享"><meta name="twitter:description" content="前言可谓是一入并发深似海，看得越多，发现自己懂的越少，总感觉自己只是了解了其冰山一角。但是在研究的过程中越来越感受到一些框架的设计之美，很细腻的赶脚。同时也让我get到了新的知识点。"><meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/15055480-87e98ecb261662b9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><link rel="alternate" href="/atom.xml" title="mars Blog" type="application/atom+xml"><link rel="canonical" href="https://www.hcyhj.cn/2019/01/08/faslesharing/"><script type="text/javascript" id="page.configurations">CONFIG.page={sidebar:""}</script><title>并发不得不说的伪共享 | mars Blog</title><noscript><style type="text/css">.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">mars Blog</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">learner</p></div><div class="site-nav-toggle"><button aria-label="Toggle navigation bar"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://www.hcyhj.cn/2019/01/08/faslesharing/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="mars"><meta itemprop="description" content="You don't have to be great to start, but you have to start to be great!"><meta itemprop="image" content="/images/head.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="mars Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">并发不得不说的伪共享</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2019-01-08 23:46:03 / Modified: 23:50:35" itemprop="dateCreated datePublished" datetime="2019-01-08T23:46:03+08:00">2019-01-08</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a></span> </span><span id="/2019/01/08/faslesharing/" class="leancloud_visitors" data-flag-title="并发不得不说的伪共享"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">Views: </span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>可谓是一入<strong>并发</strong>深似海，看得越多，发现自己懂的越少，总感觉自己只是了解了其冰山一角。但是在研究的过程中越来越感受到一些框架的设计之美，很细腻的赶脚。同时也让我get到了新的知识点。</p><a id="more"></a><hr><h4 id="CPU缓存"><a href="#CPU缓存" class="headerlink" title="CPU缓存"></a>CPU缓存</h4><blockquote><p>在正式进入正题之前，必须得先说说缓存这个概念。对于缓存这个概念相信大多数程序猿都不会很陌生，在大大小小项目中都会遇到。举个最简单的例子：数据一般都会存放到数据库之中。但在某些应用场景中不可能每次加载数据都去从数据库中加载（毕竟io操作是非常耗时和耗性能的），而是会用redis之类的缓存中间件去过渡，在缓存中未命中的时候才会从数据库中去加载。<br>这里CPU也用到了缓存的思想，但是设计会复杂许多，它会分多级缓存，包括本地核心L1，L2缓存以及同槽核心共享的L3缓存。这种设计可以让CPU更加高效的去执行咱们的代码，毕竟CPU到主内存中去取数据还是一个比较耗时的操作。这里还有一个缓存行的概念问题，大家只要知道它是CPU缓存的最小单位即可。(这一块只是引入CPU缓存这个概念，具体一些细节可以自行百度，有很多大牛对这一块的解释很细！)</p></blockquote><hr><h4 id="TrueSharing"><a href="#TrueSharing" class="headerlink" title="TrueSharing"></a>TrueSharing</h4><p>步入正题，下面是我截取的<a href="https://github.com/LMAX-Exchange/disruptor" target="_blank" rel="noopener">Disruptor框架</a>中的一段源码：<br><img src="https://upload-images.jianshu.io/upload_images/15055480-87e98ecb261662b9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="padding.png"></p><p>这么长一段代码，主要是为了包装<code>value</code>这个值。初始看来，也是一头雾水，不知其所以然，一度认为这种设计还造成内存的浪费。后面通过查阅一些资料，才发现在并发情况下这种包装是多么的完美，可以大大减少缓存不命中的几率。</p><blockquote><p>简单分析一下：一个long类型的值占用8个字节，现在大多数CPU的缓存行都是64个字节的，也就是可以存放8个long类型的单元数据，现在采用上图所示的方式加载<code>value</code>到缓存行中，可以保证不会存在任意一个有效的值与<code>value</code>共存在同一缓存行（这里默认p1…..p15均是无效值）。</p></blockquote><p><img src="https://upload-images.jianshu.io/upload_images/15055480-e477d3af94aae0f3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="cacheline.png"></p><p>为什么不能共存在同一缓存行？</p><blockquote><p>这里假设有value1与value2共存在同一缓存行（这里前提是volatile修饰的变量）。A，B线程分别修改value1，value2的值。当A线程修改value1之后，会导致整个缓存行失效，然后B线程想修改value2的值的时候就会导致无法命中缓存，然后就会从L3甚至是从主内存中去重新加载value2的值。这一会使程序运行的效率大大降低。</p></blockquote><p>细心的朋友可能注意到了我上面有一句话:<code>这里前提是volatile修饰的变量</code>,这里还得再强调一遍，如果不是volatile修饰的变量，缓存行应该是不会立即失效的，也就是还会读到脏数据。因为CPU保证一个缓存行失效并得到确认失效的返回通知相对于CPU来说也是一个很耗时的操作，会白白浪费执行权。所以这里有个<code>Invalidate Queues</code>的知识点，CPU会将失效指令写入到<code>Invalidate Queues</code>中，然后由用户自行决定什么时候执行<code>Invalidate Queues</code>中的指令。</p><blockquote><p>维基百科中关于<a href="https://en.wikipedia.org/wiki/MESI_protocol" target="_blank" rel="noopener">Invalidate Queues</a>有这样一段介绍：<br>With regard to invalidation messages, CPUs implement invalidate queues, whereby incoming invalidate requests are instantly acknowledged but not in fact acted upon. Instead, invalidation messages simply enter an invalidation queue and their processing occurs as soon as possible (but not necessarily instantly). Consequently, a CPU can be oblivious to the fact that a cache line in its cache is actually invalid, as the invalidation queue contains invalidations which have been received but haven’t yet been applied. Note that, unlike the store buffer, the CPU can’t scan the invalidation queue, as that CPU and the invalidation queue are physically located on opposite sides of the cache.<br>As a result, memory barriers are required. A store barrier will flush the store buffer, ensuring all writes have been applied to that CPU’s cache. A read barrier will flush the invalidation queue, thus ensuring that all writes by other CPUs become visible to the flushing CPU.</p></blockquote><p>大概意思就是无效的消息会进入到一个无效队列中，但不会立即被处理，因此导致实际上CPU是无法知晓该缓存行是失效了的，CPU也无法主动去扫描这个无效队列，需要内存屏障来帮助我们去<code>flush</code>失效队列。</p><p>变量申明为<code>volatile</code>后便会在读取前有一个<code>read barrier</code>，写入后有个<code>store barrier</code>，这样可以使<code>Store Buffer 与 Invalidate Queues</code>中的指令都会被刷新。这样可以保证所有的写都能同步的被应用，缓存行的失效也会被同步，只不过这里会导致一些性能上的损耗，但是和正确的进行高并发比起来，这点损耗也是能够接受的。</p><hr><h4 id="FalseSharing"><a href="#FalseSharing" class="headerlink" title="FalseSharing"></a>FalseSharing</h4><p>下面演示一下伪共享的可怕之处：<br></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FalseSharing</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> NUM_THREADS = <span class="number">2</span>; <span class="comment">// 改变多个线程</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> ITERATIONS = <span class="number">500L</span> * <span class="number">1000L</span> * <span class="number">1000L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> arrayIndex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> VolatileLong[] longs = <span class="keyword">new</span> VolatileLong[NUM_THREADS];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; longs.length; i++) &#123;</span><br><span class="line">            longs[i] = <span class="keyword">new</span> VolatileLong();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FalseSharing</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> arrayIndex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.arrayIndex = arrayIndex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">        runTest();</span><br><span class="line">        System.out.println(<span class="string">"duration = "</span> + (System.nanoTime() - start));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runTest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread[] threads = <span class="keyword">new</span> Thread[NUM_THREADS];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; threads.length; i++) &#123;</span><br><span class="line">            threads[i] = <span class="keyword">new</span> Thread(<span class="keyword">new</span> FalseSharing(i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Thread t : threads) &#123;</span><br><span class="line">            t.start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Thread t : threads) &#123;</span><br><span class="line">            t.join();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> i = ITERATIONS + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">0</span> != --i) &#123;</span><br><span class="line">            longs[arrayIndex].value = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">VolatileLong</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">long</span> p1, p2, p3, p4, p5, p6, p7; <span class="comment">// 填充</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">volatile</span> <span class="keyword">long</span> value = <span class="number">0L</span>;</span><br><span class="line"><span class="comment">//        public  long value = 0L;</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">long</span> p8, p9, p10, p11, p12, p13, p14; <span class="comment">//  填充</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p><img src="https://upload-images.jianshu.io/upload_images/15055480-b64e0bf573f58e89.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><p>上面是我分别将<code>NUM_THREADS</code>值改为1,2,3,4后的测试结果，每个线程进行了5亿次迭代，可以发现在<code>public long value = 0L</code>情况下，有没有填充均对结果无太大影响，最后耗费时间基本持平。但是<code>public volatile long value</code>情况下，填充前后耗费时间成倍增长。由此可以观察出<strong>伪共享</strong>的情况下对性能的影响是有多大了吧。</p><hr><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>要想写出高效的代码必须得对细节把控到位，虽然研究的过程是有些许枯燥，但是不停的get新知识还是很舒服的。上面也许有理解不到位的地方，大家可以一起探讨一下，共同进步。</p><hr><h4 id="END"><a href="#END" class="headerlink" title="END"></a>END</h4></div><div><div id="wechat_subscriber" style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"><img id="wechat_subscriber_qcode" src="/images/mars_jun.jpg" alt="mars wechat" style="width:200px;max-width:100%"><div>扫码加入公众号,获取最新文章!</div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/java-jvm/" rel="tag"># java jvm</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/12/30/thread-cache/" rel="next" title="线程的缓存何时刷新？"><i class="fa fa-chevron-left"></i> 线程的缓存何时刷新？</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2019/01/13/netty-NioEventLoopGroup/" rel="prev" title="Netty系列（一）：NioEventLoopGroup源码解析">Netty系列（一）：NioEventLoopGroup源码解析 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">Overview</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/head.jpg" alt="mars"><p class="site-author-name" itemprop="name">mars</p><p class="site-description motion-element" itemprop="description">You don't have to be great to start, but you have to start to be great!</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">10</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">4</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">10</span> <span class="site-state-item-name">tags</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/crazyStrongboy" title="GitHub &rarr; https://github.com/crazyStrongboy" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://www.cnblogs.com/itjun" title="cnblog &rarr; https://www.cnblogs.com/itjun" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i>cnblog</a> </span><span class="links-of-author-item"><a href="https://www.jianshu.com/u/55f7b32e6cfa" title="简书 &rarr; https://www.jianshu.com/u/55f7b32e6cfa" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>简书</a> </span><span class="links-of-author-item"><a href="https://juejin.im/user/5bf3fb2de51d4553f4271bda" title="掘金 &rarr; https://juejin.im/user/5bf3fb2de51d4553f4271bda" rel="noopener" target="_blank"><i class="fa fa-fw fa-vk"></i>掘金</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CPU缓存"><span class="nav-number">2.</span> <span class="nav-text">CPU缓存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TrueSharing"><span class="nav-number">3.</span> <span class="nav-text">TrueSharing</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#FalseSharing"><span class="nav-number">4.</span> <span class="nav-text">FalseSharing</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#END"><span class="nav-number">6.</span> <span class="nav-text">END</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span> <span class="with-love" id="animate"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">mars</span></div><div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div><span class="post-meta-divider">|</span><div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v6.5.0</div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv" title="Total Visitors"><i class="fa fa-user"></i> <span class="busuanzi-value" id="busuanzi_value_site_uv"></span> </span><span class="site-pv" title="Total Views"><i class="fa fa-eye"></i> <span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script><script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script><script type="text/javascript" src="/js/src/affix.js?v=6.5.0"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.5.0"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=6.5.0"></script><script type="text/javascript" src="/js/src/post-details.js?v=6.5.0"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script><script>function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function ({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
            Counter('put', `/classes/Counter/${counter.objectId}`, JSON.stringify({ time: { "__op":"Increment", "amount":1 } }))
            
            .done(function () {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(counter.time + 1);
            })
            
            .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
            })
          } else {
            
              Counter('post', '/classes/Counter', JSON.stringify({ title: title, url: url, time: 1}))
                .done(function () {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(1);
                })
                .fail(function () {
                  console.log('Failed to create');
                });
            
          }
        })
      .fail(function ({ responseJSON }) {
        console.log('LeanCloud Counter Error:' + responseJSON.code + " " + responseJSON.error);
      });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + "M7HOd7GinhikCfKrppNT4BsI-gzGzoHsz")
        .done(function ({ api_server }) {
          var Counter = function (method, url, data) {
            return $.ajax({
              method: method,
              url: `https://${api_server}/1.1${url}`,
              headers: {
                'X-LC-Id': "M7HOd7GinhikCfKrppNT4BsI-gzGzoHsz",
                'X-LC-Key': "fYcxkUFYa2Esa3qfsRmWmUhf",
                'Content-Type': 'application/json',
              },
              data: data,
            });
          };
          
          addCount(Counter);
          
        })
    });</script></body></html><!-- rebuild by neat -->