<!-- build time:Sun Jan 13 2019 23:05:58 GMT+0800 (China Standard Time) --><!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0"><link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"6.5.0",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="前言对于NioEventLoopGroup这个对象，在我的理解里面它就和ThreadGroup类似，NioEventLoopGroup中有一堆NioEventLoop小弟，ThreadGroup中有一堆Thread小弟,真正意义上干活的都是NioEventLoop和Thread这两个小弟。下面的文章大家可以类比下进行阅读，应该会很容易弄懂的。"><meta name="keywords" content="java netty"><meta property="og:type" content="article"><meta property="og:title" content="Netty系列（一）：NioEventLoopGroup源码解析"><meta property="og:url" content="https://www.hcyhj.cn/2019/01/13/netty-NioEventLoopGroup/index.html"><meta property="og:site_name" content="mars Blog"><meta property="og:description" content="前言对于NioEventLoopGroup这个对象，在我的理解里面它就和ThreadGroup类似，NioEventLoopGroup中有一堆NioEventLoop小弟，ThreadGroup中有一堆Thread小弟,真正意义上干活的都是NioEventLoop和Thread这两个小弟。下面的文章大家可以类比下进行阅读，应该会很容易弄懂的。"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://upload-images.jianshu.io/upload_images/15055480-0f86963594e2755b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><meta property="og:updated_time" content="2019-01-13T15:05:45.638Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Netty系列（一）：NioEventLoopGroup源码解析"><meta name="twitter:description" content="前言对于NioEventLoopGroup这个对象，在我的理解里面它就和ThreadGroup类似，NioEventLoopGroup中有一堆NioEventLoop小弟，ThreadGroup中有一堆Thread小弟,真正意义上干活的都是NioEventLoop和Thread这两个小弟。下面的文章大家可以类比下进行阅读，应该会很容易弄懂的。"><meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/15055480-0f86963594e2755b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"><link rel="alternate" href="/atom.xml" title="mars Blog" type="application/atom+xml"><link rel="canonical" href="https://www.hcyhj.cn/2019/01/13/netty-NioEventLoopGroup/"><script type="text/javascript" id="page.configurations">CONFIG.page={sidebar:""}</script><title>Netty系列（一）：NioEventLoopGroup源码解析 | mars Blog</title><noscript><style type="text/css">.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">mars Blog</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">learner</p></div><div class="site-nav-toggle"><button aria-label="Toggle navigation bar"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://www.hcyhj.cn/2019/01/13/netty-NioEventLoopGroup/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="mars"><meta itemprop="description" content="You don't have to be great to start, but you have to start to be great!"><meta itemprop="image" content="/images/head.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="mars Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Netty系列（一）：NioEventLoopGroup源码解析</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2019-01-13 23:04:11 / Modified: 23:05:45" itemprop="dateCreated datePublished" datetime="2019-01-13T23:04:11+08:00">2019-01-13</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/netty/" itemprop="url" rel="index"><span itemprop="name">netty</span></a></span> </span><span id="/2019/01/13/netty-NioEventLoopGroup/" class="leancloud_visitors" data-flag-title="Netty系列（一）：NioEventLoopGroup源码解析"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">Views: </span><span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>对于<code>NioEventLoopGroup</code>这个对象，在我的理解里面它就和<code>ThreadGroup</code>类似，<code>NioEventLoopGroup</code>中有一堆<code>NioEventLoop</code>小弟，<code>ThreadGroup</code>中有一堆<code>Thread</code>小弟,真正意义上干活的都是<code>NioEventLoop</code>和<code>Thread</code>这两个小弟。下面的文章大家可以类比下进行阅读，应该会很容易弄懂的。</p><a id="more"></a><h4 id="NioEventLoopGroup"><a href="#NioEventLoopGroup" class="headerlink" title="NioEventLoopGroup"></a>NioEventLoopGroup</h4><p>这里咱们可以从<code>NioEventLoopGroup</code>最简单的无参构造函数开始。<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NioEventLoopGroup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>一步步往下走，可以发现最终调用到构造函数：<br></p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">public</span> NioEventLoopGroup(int nThreads, Executor executor, final <span class="keyword">SelectorProvider </span><span class="keyword">selectorProvider,</span></span><br><span class="line"><span class="keyword"> </span>                        final <span class="keyword">SelectStrategyFactory </span><span class="keyword">selectStrategyFactory) </span>&#123;</span><br><span class="line">    super(nThreads, executor, <span class="keyword">selectorProvider, </span><span class="keyword">selectStrategyFactory, </span>RejectedExecutionHandlers.reject())<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>参数说明：</p><ol><li>nThreads：在整个方法链的调用过程中，其值到这里为止一直为0，在没有主动配置的情况下后面会进行设置。若配置<code>io.netty.eventLoopThreads</code>系统环境变量，则优先考虑，否则设置成为<code>CPU核心数*2</code>。</li><li>executor: 到目前为止是<code>null</code>。</li><li>selectorProvider： 这里为JDK的默认实现<code>SelectorProvider.provider()</code>。</li><li>selectStrategyFactory：这里的值是DefaultSelectStrategyFactory的一个实例<code>SelectStrategyFactory INSTANCE = new DefaultSelectStrategyFactory()</code>。</li><li>RejectedExecutionHandlers：这里是个拒绝策略，这里默认的实现是队列溢出时抛出<code>RejectedExecutionException</code>异常。</li></ol><hr><h4 id="MultithreadEventLoopGroup"><a href="#MultithreadEventLoopGroup" class="headerlink" title="MultithreadEventLoopGroup"></a>MultithreadEventLoopGroup</h4><p>继续往下面走，调用父类<code>MultithreadEventLoopGroup</code>中的构造函数：<br></p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">MultithreadEventLoopGroup</span><span class="params">(<span class="keyword">int</span> nThreads, Executor executor, Object... args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(nThreads == <span class="number">0</span> ? DEFAULT_EVENT_LOOP_THREADS : nThreads, executor, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>这里可以看到判断<code>nThreads == 0</code>后就会给其附上一个默认值。继续走，调用父类<code>MultithreadEventExecutorGroup</code>中的构造方法。<br></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">MultithreadEventExecutorGroup</span><span class="params">(<span class="keyword">int</span> nThreads, Executor executor, Object... args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(nThreads, executor, DefaultEventExecutorChooserFactory.INSTANCE, args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h5 id="DefaultEventExecutorChooserFactory"><a href="#DefaultEventExecutorChooserFactory" class="headerlink" title="DefaultEventExecutorChooserFactory"></a>DefaultEventExecutorChooserFactory</h5><p>这里有个关注的点，<code>DefaultEventExecutorChooserFactory</code>。这是一个chooserFactory,用来生产<code>EventExecutorChooser</code>选择器的。而<code>EventExecutorChooser</code>的功能是用来选择哪个<code>EventExecutor</code>去执行咱们的任务。咱们从下面的代码中可以观察到<code>DefaultEventExecutorChooserFactory</code>一共给咱们提供了两种策略。<br></p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> EventExecutorChooser <span class="keyword">new</span><span class="type">Chooser</span>(EventExecutor[] executors) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isPowerOfTwo(executors.length)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">PowerOfTwoEventExecutorChooser</span>(executors);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">GenericEventExecutorChooser</span>(executors);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>这里的策略也很简单：</p><ol><li><p>如果给的线程数是2^n个，那么选择<code>PowerOfTwoEventExecutorChooser</code>这个选择器，因为这样可以采用位运算去获取执行任务的<code>EventExecutor</code>。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> EventExecutor <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> executors[idx.getAndIncrement() &amp; executors.length - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>GenericEventExecutorChooser</code>选择器，这里采用的是取模的方式去获取执行任务的<code>EventExecutor</code>。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> EventExecutor <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> executors[Math.<span class="built_in">abs</span>(idx.getAndIncrement() % executors.length)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>相比而言，<strong>位运算的效率要比取模的效率高</strong>，所以咱们在自定义线程数的时候，最好设置成为2^n个线程数。</p><hr><h4 id="干正事"><a href="#干正事" class="headerlink" title="干正事"></a>干正事</h4><p>到达最终调用的函数<br></p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> MultithreadEventExecutorGroup(<span class="built_in">int</span> nThreads, Executor executor,</span><br><span class="line">                                        EventExecutorChooserFactory chooserFactory, <span class="keyword">Object</span>... args) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nThreads &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="keyword">String</span>.format(<span class="string">"nThreads: %d (expected: &gt; 0)"</span>, nThreads));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (executor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        executor = <span class="keyword">new</span> ThreadPerTaskExecutor(newDefaultThreadFactory());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    children = <span class="keyword">new</span> EventExecutor[nThreads];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; nThreads; i ++) &#123;</span><br><span class="line">        <span class="built_in">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            children[i] = newChild(executor, args);</span><br><span class="line">            success = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> Think about if this is a good exception type</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"failed to create a child event loop"</span>, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; i; j ++) &#123;</span><br><span class="line">                    <span class="comment">//创建NioEventLoop失败后进行资源的一些释放</span></span><br><span class="line">                    children[j].shutdownGracefully();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; i; j ++) &#123;</span><br><span class="line">                    EventExecutor e = children[j];</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">while</span> (!e.isTerminated()) &#123;</span><br><span class="line">                            e.awaitTermination(Integer.MAX_VALUE, TimeUnit.SECONDS);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException interrupted) &#123;</span><br><span class="line">                        <span class="comment">// Let the caller handle the interruption.</span></span><br><span class="line">                        Thread.currentThread().interrupt();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">//这里可以去看下上面对于 DefaultEventExecutorChooserFactory的一些介绍</span></span><br><span class="line">    chooser = chooserFactory.newChooser(children);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> FutureListener&lt;<span class="keyword">Object</span>&gt; terminationListener = <span class="keyword">new</span> FutureListener&lt;<span class="keyword">Object</span>&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> operationComplete(Future&lt;<span class="keyword">Object</span>&gt; future) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">if</span> (terminatedChildren.incrementAndGet() == children.length) &#123;</span><br><span class="line">                terminationFuture.setSuccess(<span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (EventExecutor e: children) &#123;</span><br><span class="line">        <span class="comment">// 给每一个成功创建的EventExecutor 绑定一个监听终止事件</span></span><br><span class="line">        e.terminationFuture().addListener(terminationListener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Set&lt;EventExecutor&gt; childrenSet = <span class="keyword">new</span> LinkedHashSet&lt;EventExecutor&gt;(children.length);</span><br><span class="line">    Collections.addAll(childrenSet, children);</span><br><span class="line">    <span class="comment">// 弄一个只读的EventExecutor数组，方便后面快速迭代，不会抛出并发修改异常</span></span><br><span class="line">    readonlyChildren = Collections.unmodifiableSet(childrenSet);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>从上面的代码可以观察到，等了很久的executor 在这里终于给其赋值了，其值为<code>ThreadPerTaskExecutor</code>的一个实例对象，这一块的初始化赋值都是很简单的，干活调用的是如下方法:<br></p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void execute(Runnable <span class="keyword">command</span>) &#123;</span><br><span class="line">    threadFactory.newThread(<span class="keyword">command</span>).<span class="title">start</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>对这一块不是很了解的可以去查阅下线程池有关的资料，咱们重点关注一下<code>newChild</code>这个方法，可以说是上面整个流程中的重点：</p><h4 id="newChild"><a href="#newChild" class="headerlink" title="newChild"></a>newChild</h4><p><code>newChild</code>这个方法在<code>NioEventLoopGroup</code>中被重写了：<br></p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">protected EventLoop <span class="keyword">new</span><span class="type">Child</span>(Executor executor, Object... args) throws Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">NioEventLoop</span>(<span class="built_in">this</span>, executor, (SelectorProvider) args[<span class="number">0</span>],</span><br><span class="line">        ((SelectStrategyFactory) args[<span class="number">1</span>]).<span class="keyword">new</span><span class="type">SelectStrategy</span>(), (RejectedExecutionHandler) args[<span class="number">2</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>细心的小伙伴可以观察到，这里有用到SelectorProvider，SelectStrategyFactory以及RejectedExecutionHandler这个三个参数，实际上就是本文最开始初始化的三个实例对象（可以翻阅到顶部查看一下）。<br>继续往下走流程：<br></p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">NioEventLoop</span>(NioEventLoopGroup parent, Executor executor, <span class="keyword">SelectorProvider </span><span class="keyword">selectorProvider,</span></span><br><span class="line"><span class="keyword"> </span>            <span class="keyword">SelectStrategy </span><span class="keyword">strategy, </span>RejectedExecutionHandler rejectedExecutionHandler) &#123;</span><br><span class="line">    super(parent, executor, false, DEFAULT_MAX_PENDING_TASKS, rejectedExecutionHandler)<span class="comment">;</span></span><br><span class="line">    <span class="meta">if</span> (<span class="keyword">selectorProvider </span>== null) &#123;</span><br><span class="line">        throw new NullPointerException(<span class="string">"selectorProvider"</span>)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">if</span> (<span class="keyword">strategy </span>== null) &#123;</span><br><span class="line">        throw new NullPointerException(<span class="string">"selectStrategy"</span>)<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">    provider = <span class="keyword">selectorProvider;</span></span><br><span class="line"><span class="keyword"> </span>   final <span class="keyword">SelectorTuple </span><span class="keyword">selectorTuple </span>= openSelector()<span class="comment">;</span></span><br><span class="line">    <span class="keyword">selector </span>= <span class="keyword">selectorTuple.selector;</span></span><br><span class="line"><span class="keyword"> </span>   unwrappedSelector = <span class="keyword">selectorTuple.unwrappedSelector;</span></span><br><span class="line"><span class="keyword"> </span>   <span class="keyword">selectStrategy </span>= <span class="keyword">strategy;</span></span><br><span class="line"><span class="keyword">&#125;</span></span><br></pre></td></tr></table></figure><p></p><p>在上面的代码片段中除了调用父类的构造器之外就进行了参数的判空和简单的赋值。这里<code>openSelector</code>方法调用后返回<code>SelectorTuple</code>实例主要是为了能同时得到包装前后的<code>selector</code>与<code>unwrappedSelector</code>。<br></p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> SingleThreadEventExecutor(EventExecutorGroup parent, Executor executor,</span><br><span class="line">                                    boolean addTaskWakesUp, int maxPendingTasks,</span><br><span class="line">                                    RejectedExecutionHandler rejectedHandler) &#123;</span><br><span class="line">    <span class="keyword">super</span>(parent);</span><br><span class="line">    <span class="keyword">this</span>.addTaskWakesUp = addTaskWakesUp;</span><br><span class="line">    <span class="keyword">this</span>.maxPendingTasks = Math.max(<span class="number">16</span>, maxPendingTasks);</span><br><span class="line">    <span class="keyword">this</span>.executor = ObjectUtil.checkNotNull(executor, <span class="string">"executor"</span>);</span><br><span class="line">    taskQueue = newTaskQueue(<span class="keyword">this</span>.maxPendingTasks);</span><br><span class="line">    rejectedExecutionHandler = ObjectUtil.checkNotNull(rejectedHandler, <span class="string">"rejectedHandler"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>这里会有一个<code>taskQueue</code>队列的初始化（<code>Queue&lt;Runnable&gt; taskQueue</code>），看名字就知道，这个队列里面放着的是咱们要去执行的任务。这里的初始化方法<code>newTaskQueue</code>在<code>NioEventLoop</code>中重写了的。具体如下：<br></p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">protected Queue&lt;Runnable&gt; <span class="keyword">new</span><span class="type">TaskQueue</span>(int maxPendingTasks) &#123;</span><br><span class="line">    <span class="comment">// This event loop never calls takeTask()</span></span><br><span class="line">    <span class="keyword">return</span> maxPendingTasks == Integer.MAX_VALUE ? PlatformDependent.&lt;Runnable&gt;<span class="keyword">new</span><span class="type">MpscQueue</span>()</span><br><span class="line">                                                : <span class="type">PlatformDependent</span>.&lt;Runnable&gt;<span class="keyword">new</span><span class="type">MpscQueue</span>(maxPendingTasks);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>这里生成的是一个<a href="https://github.com/JCTools/JCTools" target="_blank" rel="noopener">MPSC队列(Multi Producer Single Consumer)</a>，这是一个多生产者单消费的无锁队列，支持并发。从字面意思上就可以观察到这个队列效率应该是蛮高的。这里的<code>maxPendingTasks</code>值为<code>Integer.MAX_VALUE</code>。然后最终生成的是<code>MpscUnboundedArrayQueue</code>这样一个无边界的队列。</p><p>这样<code>newChild</code>这个方法到这里就走完了。</p><hr><h4 id="terminationListener"><a href="#terminationListener" class="headerlink" title="terminationListener"></a>terminationListener</h4><p>简单介绍下这个环节，在上面的创建<code>NioEventLoopGroup</code>有个环节是给每个<code>NioEventLoop</code>儿子绑定一个terminationListener监听事件<br></p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">for</span> (EventExecutor <span class="attribute">e</span>: children) &#123;</span><br><span class="line">    <span class="selector-tag">e</span><span class="selector-class">.terminationFuture</span>()<span class="selector-class">.addListener</span>(terminationListener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>这个事件的回调方法是：<br></p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(Future&lt;Object&gt; future)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (terminatedChildren.incrementAndGet() == children.length) &#123;</span><br><span class="line">        terminationFuture.setSuccess(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>在每一个<code>NioEventLoop</code>关闭后，就会回调这个方法，然后给<code>NioEventLoopGroup</code>实例中的<code>terminatedChildren</code>字段自增1，并与初始化成功的<code>NioEventLoop</code>的总个数进行比较，如果<br><code>terminatedChildren</code>的值与<code>NioEventLoop</code>的总个数相等，则调用<code>bossGroup.terminationFuture().get()</code>方法就不会阻塞，并正常返回<code>null</code>。<br>同样，<code>future.channel().closeFuture().sync()</code>这段代码也将不会阻塞住了,调用<code>sync.get()</code>也会返回<code>null</code>。<br>下面给一段测试代码，完整示例大家可以到我的<a href="https://github.com/crazyStrongboy/wheel/tree/master/echo/src/main/java/github/com/crazyStrongboy" target="_blank" rel="noopener">github</a>中去获取：</p><p><img src="https://upload-images.jianshu.io/upload_images/15055480-0f86963594e2755b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="terminationListener_test"></p><p>上面的代码只是一个简单的测试，后面还有别的发现的话会继续在<a href="https://github.com/crazyStrongboy/wheel/tree/master/echo/src/main/java/github/com/crazyStrongboy" target="_blank" rel="noopener">github</a>中与大家一起分享~</p><hr><h4 id="End"><a href="#End" class="headerlink" title="End"></a>End</h4></div><div><div id="wechat_subscriber" style="display:block;padding:10px 0;margin:20px auto;width:100%;text-align:center"><img id="wechat_subscriber_qcode" src="/images/mars_jun.jpg" alt="mars wechat" style="width:200px;max-width:100%"><div>扫码加入公众号,获取最新文章!</div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/java-netty/" rel="tag"># java netty</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2019/01/08/faslesharing/" rel="next" title="并发不得不说的伪共享"><i class="fa fa-chevron-left"></i> 并发不得不说的伪共享</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"></div></div></footer></div></article></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">Overview</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/head.jpg" alt="mars"><p class="site-author-name" itemprop="name">mars</p><p class="site-description motion-element" itemprop="description">You don't have to be great to start, but you have to start to be great!</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">10</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">4</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">10</span> <span class="site-state-item-name">tags</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/crazyStrongboy" title="GitHub &rarr; https://github.com/crazyStrongboy" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="https://www.cnblogs.com/itjun" title="cnblog &rarr; https://www.cnblogs.com/itjun" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i>cnblog</a> </span><span class="links-of-author-item"><a href="https://www.jianshu.com/u/55f7b32e6cfa" title="简书 &rarr; https://www.jianshu.com/u/55f7b32e6cfa" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>简书</a> </span><span class="links-of-author-item"><a href="https://juejin.im/user/5bf3fb2de51d4553f4271bda" title="掘金 &rarr; https://juejin.im/user/5bf3fb2de51d4553f4271bda" rel="noopener" target="_blank"><i class="fa fa-fw fa-vk"></i>掘金</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NioEventLoopGroup"><span class="nav-number">2.</span> <span class="nav-text">NioEventLoopGroup</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MultithreadEventLoopGroup"><span class="nav-number">3.</span> <span class="nav-text">MultithreadEventLoopGroup</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#DefaultEventExecutorChooserFactory"><span class="nav-number">3.1.</span> <span class="nav-text">DefaultEventExecutorChooserFactory</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#干正事"><span class="nav-number">4.</span> <span class="nav-text">干正事</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#newChild"><span class="nav-number">5.</span> <span class="nav-text">newChild</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#terminationListener"><span class="nav-number">6.</span> <span class="nav-text">terminationListener</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#End"><span class="nav-number">7.</span> <span class="nav-text">End</span></a></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span> <span class="with-love" id="animate"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">mars</span></div><div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div><span class="post-meta-divider">|</span><div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v6.5.0</div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv" title="Total Visitors"><i class="fa fa-user"></i> <span class="busuanzi-value" id="busuanzi_value_site_uv"></span> </span><span class="site-pv" title="Total Views"><i class="fa fa-eye"></i> <span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=6.5.0"></script><script type="text/javascript" src="/js/src/motion.js?v=6.5.0"></script><script type="text/javascript" src="/js/src/affix.js?v=6.5.0"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.5.0"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=6.5.0"></script><script type="text/javascript" src="/js/src/post-details.js?v=6.5.0"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script><script>function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function ({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
            Counter('put', `/classes/Counter/${counter.objectId}`, JSON.stringify({ time: { "__op":"Increment", "amount":1 } }))
            
            .done(function () {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(counter.time + 1);
            })
            
            .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
            })
          } else {
            
              Counter('post', '/classes/Counter', JSON.stringify({ title: title, url: url, time: 1}))
                .done(function () {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(1);
                })
                .fail(function () {
                  console.log('Failed to create');
                });
            
          }
        })
      .fail(function ({ responseJSON }) {
        console.log('LeanCloud Counter Error:' + responseJSON.code + " " + responseJSON.error);
      });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + "M7HOd7GinhikCfKrppNT4BsI-gzGzoHsz")
        .done(function ({ api_server }) {
          var Counter = function (method, url, data) {
            return $.ajax({
              method: method,
              url: `https://${api_server}/1.1${url}`,
              headers: {
                'X-LC-Id': "M7HOd7GinhikCfKrppNT4BsI-gzGzoHsz",
                'X-LC-Key': "fYcxkUFYa2Esa3qfsRmWmUhf",
                'Content-Type': 'application/json',
              },
              data: data,
            });
          };
          
          addCount(Counter);
          
        })
    });</script></body></html><!-- rebuild by neat -->